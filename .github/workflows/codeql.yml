name: CodeQL Security Scan and Slack Alert

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 3 * * 1' # Runs every Monday at 3 AM UTC

jobs:
  analyze:
    name: Run CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript, python # Add more as needed

      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        id: codeql_scan
        with:
          output: codeql-results.sarif  # Defines SARIF output file

      - name: Extract CodeQL Results
        run: |
          if [ -f "codeql-results.sarif" ]; then
            jq -r '.runs[].results[].message.text' codeql-results.sarif > results.txt || echo "No issues found" > results.txt
          else
            echo "CodeQL results file missing. Skipping alert." > results.txt
          fi

      - name: Send Slack Notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -s results.txt ]; then
            RESULTS=$(cat results.txt)
            curl -X POST -H 'Content-type: application/json' --data '{
              "text": "ðŸš¨ *CodeQL Security Alert!*\n\n'"$RESULTS"'"
            }' $SLACK_WEBHOOK_URL
          else
            echo "No security issues found. Skipping Slack alert."
          fi
